go back to [[electro:simulide-sensors|Adding Sensors to SimulIDE]]

====== Add a digital sensor to SimulIDE ======

We will here show how to add a digital sensor to SimulIDE. The procedure is quite similar to the creation of an analog sensor.


===== Create a Digital Sensor Class =====
As for analog sensors, this class aims at making more simple the creation of other digital sensors.
A generic **LogicSensor** class (logic_sensor.cpp, logic_sensor.h) has been defined in :
<code bash>
src/gui/circuitwidget/components/logic/
</code>  
The class inherits from the **LogicComponent** class.
The value measured by the sensor is in the **sense** variable.

===== Create a DS1621 I2C Temperature Sensor =====
Our digital sensor is a MAXIM DS1621 temperature sensor. The sensor will give its measurements via the I2C bus.
The DS1621 sensor is defined by the **Ds1621** class (ds1621.cpp and ds1621.h) in the same folder :
<code bash>
src/gui/circuitwidget/components/logic/
</code> 
This class inherits from LogicSensor class. We will now have a quick view on this code and explain the main elements.

First we  insert the sensor in the SimulIDE item library in the "Experimental Ensta Bretagne" group we have created for the analog sensor. In fact, all experimental stuff will go here. We define the sensor with a short name, an icon and its corresponding class :
<code c++>
LibraryItem* Ds1621::libraryItem()
{
    return new LibraryItem(
        tr( "Ds1621 I2C Temperature" ),
        tr( "Experimental Ensta Bretagne" ),
        "sensor_ldr_illumination_ue22.png",
        "Ds1621",
        Ds1621::construct );
}
</code>

The main function is the constructor of the **SensorStrainGauge** object :
<code c++>
</code>
In this code, we do the following operations : 
  * defining and connecting the two pins of the sensor resistor 
  * drawing the rectangle showing the resistor in the circuit design area
  * defining the sensing unit : "N" as Newton
  * defining the component unit : "Ohm" for resistive sensor
  * set the init value of the sensor
  * defining the locations of all the labels and selecting the displayed labels at start
  * creating and initializing the dial widget
  * adding the component to the simulation
  * creating an event when dial widget changes 

In this class, we have important functions to provide to the simulator. First we need to define what is done at every simulation step, this is done  by the function **updateStep()** :
<code c++>
void SensorStrainGauge::updateStep()
{
    m_step = Simulator::self()->step();
    double t = (double) m_step/1e6;
    double dt = t - m_t0_tau;

    m_new_resist = sensorFunction (m_sense);
    double dr = m_new_resist - m_last_resist;
    // Simulate time constant with a first order linear lowpass filter
    m_resist = m_last_resist + dr * (1.0 -exp(-dt/m_tau));
    
    setUnit (" ");
    setResist ( m_resist);

    //qDebug() << "SensorStrainGauge::SensorStrainGauge" << m_res.res() << m_res.current()
    //	     << m_ePinTst1->isConnected() << m_ePinTst2->isConnected() ;
   
    m_last_step = m_step;
}
</code>
Here we use a first order linear lowpass filter to simulate the time constant of the sensor (this can be removed if you do not need time constant simulation). The commented **qDebug()** is usefull for checking that the sensor works properly.

A second interesting function is **paint()** that will draw the sensor in the circuit design area. Here we use a small image to represent the sensor, but this can also be done qith Qt drawing functions.
<code c++>
void SensorStrainGauge::paint( QPainter *p, const QStyleOptionGraphicsItem *option, QWidget *widget )
{
    Component::paint( p, option, widget );
    p->drawRect( -16, -4, 32, 8 );
    p->drawImage(QRect(-15, -40, 30, 30),
		 QImage(QString(":/sensor_strain_gauge.png")));
}
</code>

A third interesting function is **** than compute the resistance **r_sense** of the resistor as the function of the sensor value **sense**. Here we implement a classical strain gauge function with temperature dependency.
<code c++>
double SensorStrainGauge::sensorFunction (double sense)
{
  double r_sense;
  m_k_long = 1+2.0*m_coef_poisson+m_cste_bridgman*(1-2*m_coef_poisson);
  m_k = m_k_long * (1 - m_coef_transverse);
  m_section_body = m_h_body * m_w_body;
  m_delta_r = m_r0*m_k*sense/(m_young_modulus*m_section_body);
  m_delta_r_t = (m_alpha_r+m_k*(m_lambda_s - m_lambda_j)) * (m_temperature - m_reference_temperature) * m_r0;
  r_sense = m_r0 + m_delta_r + m_delta_r_t;
  return r_sense;
}
</code>
===== Adding an Icon or an Image =====
We may need images or icon to show the sensor either in the item library or in the circuit design area. In the circuit area, the display of the component if a combination of Qt graphics and images. First we add the image (ex sensor_strain_gauge.png in Downloads folder) in the **src/icons/components** folder :
<code bash>
cp ~/Downloads/sensor_strain_gauge.png src/icons/components/
</code>
Then an alias is defined at the end of **src/application.qrc** file before </qresource> :
<code xml>
<file alias="sensor_strain_gauge.png">../src/icons/components/sensor_strain_gauge.png</file>
</code>

===== Adding the Sensor in the Item Library =====
The sensor is now added in the item library by adding 2 lines in **src/gui/circuitwidget/itemlibrary.cpp** file. First we include the definition of the sensor class in the include section of the code :
<code c++>
#include "sensor_strain_gauge.h"
</code>
And second, we add the **SensorStrainGauge** item after the last item (here SubPackage). This experimental component will be in **Experimental Ensta Bretagne** in the **Other** tab :
<code c++>
    addItem( SubPackage::libraryItem() );

    //Experimental Ensta Bretagne
    addItem( new LibraryItem( tr("Experimental Ensta Bretagne"),tr("Other"), "ensta_experimental.png","", 0l ) );
    addItem( SensorStrainGauge::libraryItem() );
}
</code>

===== Building and Testing =====
In the **build_linux** folder type :
<code bash>
qmake & make
./executables/SimulIDE_0.4.15-Final/bin/simulide 
</code>

SimulIDE should have started and the new experimental menu should appear as this :

{{:electro:simulide-strain-gauge-menu.png?300|}}

The strain gauge sensor can now be used in a circuit as shown here when inserted in a voltage divider; Note that such sensor with little changes in resistance should preferably be inserted in a Wheatstone bridge.

{{:electro:simulide-strain-gauge-circuit.png?400|}}
